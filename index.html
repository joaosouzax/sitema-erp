<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema ERP - Gest√£o de Estoque</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f3f4f6;
            --border: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: var(--dark);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            background: var(--light);
            padding: 10px;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            background: var(--light);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input, select, textarea {
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        button {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: var(--warning);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        th {
            background: var(--dark);
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 14px;
            font-weight: 600;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        tr:hover {
            background: #fafafa;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fed7aa;
            color: #92400e;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            color: #6b7280;
            font-size: 14px;
            margin-top: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            animation: slideUp 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-bar input {
            flex: 1;
            max-width: 400px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid var(--success);
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid var(--danger);
        }

        .alert-warning {
            background: #fed7aa;
            color: #92400e;
            border-left: 4px solid var(--warning);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .file-upload {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .search-bar {
                flex-direction: column;
            }
            
            .search-bar input {
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <div class="logo">ERP</div>
                Sistema de Gest√£o de Estoque
            </h1>
            <div style="display: flex; align-items: center; gap: 20px;">
                <span id="currentTime"></span>
                <button onclick="toggleTheme()" style="padding: 8px; background: transparent; border: 1px solid white;">
                    üåô
                </button>
            </div>
        </header>

        <div class="nav-tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('products')">üì¶ Produtos</button>
            <button class="tab" onclick="switchTab('movements')">üîÑ Movimenta√ß√µes</button>
            <button class="tab" onclick="switchTab('excel')">üìã Excel</button>
            <button class="tab" onclick="switchTab('reports')">üìà Relat√≥rios</button>
        </div>

        <div class="content">
            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalProducts">0</div>
                        <div class="stat-label">Total de Produtos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalStock">0</div>
                        <div class="stat-label">Itens em Estoque</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalValue">R$ 0</div>
                        <div class="stat-label">Valor Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="todayMovements">0</div>
                        <div class="stat-label">Movimenta√ß√µes Hoje</div>
                    </div>
                </div>

                <div class="section">
                    <h2>üìä Produtos com Estoque Baixo</h2>
                    <table id="lowStockTable">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Produto</th>
                                <th>Quantidade</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="section">
                    <h2>üìà √öltimas Movimenta√ß√µes</h2>
                    <table id="recentMovements">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Produto</th>
                                <th>Tipo</th>
                                <th>Quantidade</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Produtos -->
            <div id="products" class="tab-content">
                <div class="section">
                    <h2>‚ûï Cadastrar Produto</h2>
                    <form id="productForm" class="form-grid">
                        <div class="form-group">
                            <label>SKU</label>
                            <input type="text" id="sku" placeholder="Ex: PROD001" required>
                        </div>
                        <div class="form-group">
                            <label>Nome</label>
                            <input type="text" id="name" placeholder="Nome do produto" required>
                        </div>
                        <div class="form-group">
                            <label>Quantidade Inicial</label>
                            <input type="number" id="quantity" placeholder="0" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Pre√ßo (R$)</label>
                            <input type="number" id="price" placeholder="0.00" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Fornecedor</label>
                            <input type="text" id="supplier" placeholder="Nome do fornecedor">
                        </div>
                        <div class="form-group">
                            <label>Estoque M√≠nimo</label>
                            <input type="number" id="minStock" placeholder="10" min="0">
                        </div>
                        <div class="form-group" style="align-self: flex-end;">
                            <button type="submit">
                                <span>‚ûï</span> Cadastrar Produto
                            </button>
                        </div>
                    </form>
                </div>

                <div class="section">
                    <h2>üì¶ Lista de Produtos</h2>
                    <div class="search-bar">
                        <input type="text" id="searchProduct" placeholder="Buscar por nome ou SKU..." oninput="searchProducts()">
                        <button onclick="exportProducts()">üì• Exportar Excel</button>
                    </div>
                    <table id="productsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>SKU</th>
                                <th>Nome</th>
                                <th>Quantidade</th>
                                <th>Pre√ßo</th>
                                <th>Valor Total</th>
                                <th>Fornecedor</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Movimenta√ß√µes -->
            <div id="movements" class="tab-content">
                <div class="section">
                    <h2>üîÑ Registrar Movimenta√ß√£o</h2>
                    <form id="movementForm" class="form-grid">
                        <div class="form-group">
                            <label>Produto</label>
                            <select id="movProductId" required>
                                <option value="">Selecione um produto</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tipo</label>
                            <select id="movType" required>
                                <option value="IN">Entrada</option>
                                <option value="OUT">Sa√≠da</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Quantidade</label>
                            <input type="number" id="movQuantity" min="1" required>
                        </div>
                        <div class="form-group">
                            <label>Respons√°vel</label>
                            <input type="text" id="movUser" placeholder="Nome do respons√°vel" required>
                        </div>
                        <div class="form-group">
                            <label>Observa√ß√µes</label>
                            <input type="text" id="movNotes" placeholder="Observa√ß√µes (opcional)">
                        </div>
                        <div class="form-group" style="align-self: flex-end;">
                            <button type="submit" class="btn-success">
                                <span>‚úì</span> Registrar Movimenta√ß√£o
                            </button>
                        </div>
                    </form>
                </div>

                <div class="section">
                    <h2>üìã Hist√≥rico de Movimenta√ß√µes</h2>
                    <div class="search-bar">
                        <input type="date" id="startDate">
                        <input type="date" id="endDate">
                        <button onclick="filterMovements()">üîç Filtrar</button>
                        <button onclick="clearFilter()">‚ùå Limpar</button>
                        <button onclick="exportMovements()">üì• Exportar Excel</button>
                    </div>
                    <table id="movementsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Data/Hora</th>
                                <th>Produto</th>
                                <th>Tipo</th>
                                <th>Quantidade</th>
                                <th>Respons√°vel</th>
                                <th>Saldo Ap√≥s</th>
                                <th>Observa√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Excel Integration -->
            <div id="excel" class="tab-content">
                <div class="section">
                    <h2>üìã Importar do Excel</h2>
                    <div class="file-upload" onclick="document.getElementById('excelFile').click()">
                        <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="handleExcelImport(this)" style="display: none;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üìÅ</div>
                        <h3>Clique aqui para selecionar um arquivo Excel</h3>
                        <p style="color: #6b7280; margin-top: 10px;">Formatos aceitos: .xlsx, .xls, .csv</p>
                    </div>
                    
                    <div id="importPreview" style="display: none; margin-top: 20px;">
                        <h3>Pr√©via dos Dados</h3>
                        <div style="margin: 20px 0;">
                            <label>Tipo de Importa√ß√£o:</label>
                            <select id="importType">
                                <option value="products">Produtos</option>
                                <option value="movements">Movimenta√ß√µes</option>
                            </select>
                            <button onclick="confirmImport()" class="btn-success">‚úì Confirmar Importa√ß√£o</button>
                        </div>
                        <div id="previewTable"></div>
                    </div>
                </div>

                <div class="section">
                    <h2>üì§ Exportar para Excel</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <button onclick="exportProducts()" class="btn-success">
                            üì¶ Exportar Produtos
                        </button>
                        <button onclick="exportMovements()" class="btn-success">
                            üîÑ Exportar Movimenta√ß√µes
                        </button>
                        <button onclick="exportInventoryReport()" class="btn-success">
                            üìä Relat√≥rio de Invent√°rio
                        </button>
                        <button onclick="exportDashboardData()" class="btn-success">
                            üìà Dados do Dashboard
                        </button>
                    </div>
                </div>

                <div class="section">
                    <h2>üìã Templates Excel</h2>
                    <p style="margin-bottom: 20px; color: #6b7280;">
                        Baixe os templates para importar dados no formato correto:
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <button onclick="downloadTemplate('products')" class="btn-warning">
                            üì¶ Template Produtos
                        </button>
                        <button onclick="downloadTemplate('movements')" class="btn-warning">
                            üîÑ Template Movimenta√ß√µes
                        </button>
                    </div>
                </div>
            </div>

            <!-- Relat√≥rios -->
            <div id="reports" class="tab-content">
                <div class="section">
                    <h2>üìà Relat√≥rios e An√°lises</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="monthlyIn">0</div>
                            <div class="stat-label">Entradas no M√™s</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="monthlyOut">0</div>
                            <div class="stat-label">Sa√≠das no M√™s</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="turnoverRate">0%</div>
                            <div class="stat-label">Taxa de Giro</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgStockValue">R$ 0</div>
                            <div class="stat-label">Valor M√©dio Estoque</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>üìä Produtos Mais Movimentados</h2>
                    <div class="chart-container">
                        <canvas id="chartCanvas" width="400" height="200"></canvas>
                    </div>
                </div>

                <div class="section">
                    <h2>üîç An√°lise ABC</h2>
                    <table id="abcTable">
                        <thead>
                            <tr>
                                <th>Classifica√ß√£o</th>
                                <th>Produto</th>
                                <th>Valor em Estoque</th>
                                <th>% do Total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Edi√ß√£o -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Editar Produto</h2>
            <form id="editForm" class="form-grid" style="margin-top: 20px;">
                <div class="form-group">
                    <label>SKU</label>
                    <input type="text" id="editSku" required>
                </div>
                <div class="form-group">
                    <label>Nome</label>
                    <input type="text" id="editName" required>
                </div>
                <div class="form-group">
                    <label>Quantidade</label>
                    <input type="number" id="editQuantity" min="0" required>
                </div>
                <div class="form-group">
                    <label>Pre√ßo (R$)</label>
                    <input type="number" id="editPrice" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Fornecedor</label>
                    <input type="text" id="editSupplier">
                </div>
                <div class="form-group">
                    <label>Estoque M√≠nimo</label>
                    <input type="number" id="editMinStock" min="0">
                </div>
            </form>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                <button onclick="saveEdit()" class="btn-success">üíæ Salvar</button>
                <button onclick="closeModal()" class="btn-danger">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Scripts externos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Estado da aplica√ß√£o
        let products = [];
        let movements = [];
        let currentEditingId = null;
        let importData = [];

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            loadSampleData();
            updateDashboard();
            updateClock();
            setInterval(updateClock, 1000);
        });

        // Carregar dados de exemplo
        function loadSampleData() {
            products = [
                { id: 1, sku: 'FOGO001', name: 'Roj√£o Trov√£o Colorido', quantity: 150, price: 12.50, supplier: 'Fogos S√£o Jo√£o', minStock: 20 },
                { id: 2, sku: 'FOGO002', name: 'Morteiro 3 Polegadas', quantity: 45, price: 85.00, supplier: 'Pirotecnia Brasil', minStock: 10 },
                { id: 3, sku: 'FOGO003', name: 'Chuva de Prata', quantity: 8, price: 65.00, supplier: 'Fogos Minas', minStock: 5 },
                { id: 4, sku: 'FOGO004', name: 'Bomba Cora√ß√£o Apaixonado', quantity: 22, price: 35.00, supplier: 'Pirotecnia Brasil', minStock: 8 },
                { id: 5, sku: 'FOGO005', name: 'Cascata Dourada', quantity: 12, price: 45.00, supplier: 'Fogos S√£o Jo√£o', minStock: 6 },
                { id: 6, sku: 'FOGO006', name: 'Espada Cintilante', quantity: 30, price: 18.00, supplier: 'Fogos Minas', minStock: 15 },
                { id: 7, sku: 'FOGO007', name: 'Torta 25 Tiros', quantity: 5, price: 120.00, supplier: 'Pirotecnia Brasil', minStock: 3 },
                { id: 8, sku: 'FOGO008', name: 'Vulc√£o de Fogo', quantity: 18, price: 95.00, supplier: 'Fogos S√£o Jo√£o', minStock: 5 }
            ];

            const now = new Date();
            movements = [
                { id: 1, productId: 1, type: 'IN', quantity: 50, user: 'Jo√£o Silva', date: new Date(now - 86400000), notes: 'Estoque para festa junina' },
                { id: 2, productId: 2, type: 'OUT', quantity: 5, user: 'Maria Santos', date: new Date(now - 43200000), notes: 'Venda casamento' },
                { id: 3, productId: 3, type: 'IN', quantity: 20, user: 'Pedro Costa', date: new Date(now - 3600000), notes: 'Reposi√ß√£o estoque' },
                { id: 4, productId: 4, type: 'OUT', quantity: 3, user: 'Ana Lima', date: new Date(), notes: 'Venda anivers√°rio' },
                { id: 5, productId: 7, type: 'OUT', quantity: 2, user: 'Carlos Souza', date: new Date(), notes: 'Evento corporativo' },
                { id: 6, productId: 6, type: 'IN', quantity: 25, user: 'Roberto Silva', date: new Date(now - 7200000), notes: 'Compra fornecedor' },
                { id: 7, productId: 8, type: 'OUT', quantity: 1, user: 'Fernanda Costa', date: new Date(now - 1800000), notes: 'Show pirot√©cnico' }
            ];

            updateAllTables();
        }

        // Atualizar rel√≥gio
        function updateClock() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('pt-BR');
        }

        // Trocar abas
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'products') updateProductsTable();
            if (tabName === 'movements') updateMovementsTable();
            if (tabName === 'reports') updateReports();
        }

        // Dashboard
        function updateDashboard() {
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('totalStock').textContent = products.reduce((sum, p) => sum + p.quantity, 0);
            
            const totalValue = products.reduce((sum, p) => sum + (p.quantity * p.price), 0);
            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            
            const today = new Date().toDateString();
            const todayMovs = movements.filter(m => m.date.toDateString() === today).length;
            document.getElementById('todayMovements').textContent = todayMovs;

            // Produtos com estoque baixo
            const lowStock = products.filter(p => p.quantity <= (p.minStock || 10));
            const lowStockTable = document.querySelector('#lowStockTable tbody');
            lowStockTable.innerHTML = '';
            
            if (lowStock.length === 0) {
                lowStockTable.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #9ca3af;">Nenhum produto com estoque baixo</td></tr>';
            } else {
                lowStock.forEach(product => {
                    const status = product.quantity === 0 ? 'danger' : product.quantity < 5 ? 'warning' : 'success';
                    lowStockTable.innerHTML += `
                        <tr>
                            <td>${product.sku}</td>
                            <td>${product.name}</td>
                            <td>${product.quantity}</td>
                            <td><span class="badge badge-${status}">${getStatusLabel(product.quantity)}</span></td>
                        </tr>
                    `;
                });
            }

            // Movimenta√ß√µes recentes
            const recentMovs = movements.slice(-5).reverse();
            const recentTable = document.querySelector('#recentMovements tbody');
            recentTable.innerHTML = '';
            
            recentMovs.forEach(mov => {
                const product = products.find(p => p.id === mov.productId);
                const typeClass = mov.type === 'IN' ? 'success' : 'danger';
                recentTable.innerHTML += `
                    <tr>
                        <td>${formatDateTime(mov.date)}</td>
                        <td>${product ? product.name : 'Produto removido'}</td>
                        <td><span class="badge badge-${typeClass}">${mov.type === 'IN' ? 'Entrada' : 'Sa√≠da'}</span></td>
                        <td>${mov.quantity}</td>
                    </tr>
                `;
            });
        }

        // Produtos
        function updateProductsTable() {
            const tbody = document.querySelector('#productsTable tbody');
            tbody.innerHTML = '';

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #9ca3af;">Nenhum produto cadastrado</td></tr>';
                return;
            }

            products.forEach(product => {
                const totalValue = product.quantity * product.price;
                tbody.innerHTML += `
                    <tr>
                        <td>${product.id}</td>
                        <td>${product.sku}</td>
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>${formatCurrency(product.price)}</td>
                        <td>${formatCurrency(totalValue)}</td>
                        <td>${product.supplier || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button onclick="editProduct(${product.id})" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è Editar</button>
                                <button onclick="deleteProduct(${product.id})" class="btn-danger" style="padding: 6px 12px; font-size: 12px;">üóëÔ∏è Excluir</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            updateMovementSelects();
        }

        function updateMovementsTable() {
            const tbody = document.querySelector('#movementsTable tbody');
            tbody.innerHTML = '';

            if (movements.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #9ca3af;">Nenhuma movimenta√ß√£o registrada</td></tr>';
                return;
            }

            movements.slice().reverse().forEach(mov => {
                const product = products.find(p => p.id === mov.productId);
                const typeClass = mov.type === 'IN' ? 'success' : 'danger';
                
                // Calcular saldo ap√≥s movimenta√ß√£o
                const movementIndex = movements.indexOf(mov);
                let balance = 0;
                for (let i = 0; i <= movementIndex; i++) {
                    const m = movements[i];
                    if (m.productId === mov.productId) {
                        balance += m.type === 'IN' ? m.quantity : -m.quantity;
                    }
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${mov.id}</td>
                        <td>${formatDateTime(mov.date)}</td>
                        <td>${product ? product.name : 'Produto removido'}</td>
                        <td><span class="badge badge-${typeClass}">${mov.type === 'IN' ? 'Entrada' : 'Sa√≠da'}</span></td>
                        <td>${mov.quantity}</td>
                        <td>${mov.user}</td>
                        <td>${balance}</td>
                        <td>${mov.notes || '-'}</td>
                    </tr>
                `;
            });
        }

        function updateMovementSelects() {
            const select = document.getElementById('movProductId');
            select.innerHTML = '<option value="">Selecione um produto</option>';
            
            products.forEach(product => {
                select.innerHTML += `<option value="${product.id}">${product.name} (${product.sku})</option>`;
            });
        }

        function updateAllTables() {
            updateProductsTable();
            updateMovementsTable();
            updateDashboard();
        }

        // Formul√°rios
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newProduct = {
                id: products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1,
                sku: document.getElementById('sku').value,
                name: document.getElementById('name').value,
                quantity: parseInt(document.getElementById('quantity').value),
                price: parseFloat(document.getElementById('price').value),
                supplier: document.getElementById('supplier').value,
                minStock: parseInt(document.getElementById('minStock').value) || 10
            };

            // Verificar se SKU j√° existe
            if (products.some(p => p.sku === newProduct.sku)) {
                showAlert('SKU j√° existe! Use um c√≥digo diferente.', 'danger');
                return;
            }

            products.push(newProduct);
            this.reset();
            updateAllTables();
            showAlert('Produto cadastrado com sucesso!', 'success');
        });

        document.getElementById('movementForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productId = parseInt(document.getElementById('movProductId').value);
            const type = document.getElementById('movType').value;
            const quantity = parseInt(document.getElementById('movQuantity').value);
            const product = products.find(p => p.id === productId);

            if (!product) {
                showAlert('Produto n√£o encontrado!', 'danger');
                return;
            }

            // Verificar se h√° estoque suficiente para sa√≠da
            if (type === 'OUT' && product.quantity < quantity) {
                showAlert('Estoque insuficiente!', 'danger');
                return;
            }

            const newMovement = {
                id: movements.length > 0 ? Math.max(...movements.map(m => m.id)) + 1 : 1,
                productId: productId,
                type: type,
                quantity: quantity,
                user: document.getElementById('movUser').value,
                date: new Date(),
                notes: document.getElementById('movNotes').value
            };

            // Atualizar estoque
            if (type === 'IN') {
                product.quantity += quantity;
            } else {
                product.quantity -= quantity;
            }

            movements.push(newMovement);
            this.reset();
            updateAllTables();
            showAlert('Movimenta√ß√£o registrada com sucesso!', 'success');
        });

        // Fun√ß√µes de edi√ß√£o e exclus√£o
        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            currentEditingId = id;
            document.getElementById('editSku').value = product.sku;
            document.getElementById('editName').value = product.name;
            document.getElementById('editQuantity').value = product.quantity;
            document.getElementById('editPrice').value = product.price;
            document.getElementById('editSupplier').value = product.supplier || '';
            document.getElementById('editMinStock').value = product.minStock || 10;
            
            document.getElementById('editModal').classList.add('active');
        }

        function saveEdit() {
            if (!currentEditingId) return;

            const product = products.find(p => p.id === currentEditingId);
            const newSku = document.getElementById('editSku').value;

            // Verificar se SKU j√° existe (exceto para o produto atual)
            if (products.some(p => p.sku === newSku && p.id !== currentEditingId)) {
                showAlert('SKU j√° existe! Use um c√≥digo diferente.', 'danger');
                return;
            }

            product.sku = newSku;
            product.name = document.getElementById('editName').value;
            product.quantity = parseInt(document.getElementById('editQuantity').value);
            product.price = parseFloat(document.getElementById('editPrice').value);
            product.supplier = document.getElementById('editSupplier').value;
            product.minStock = parseInt(document.getElementById('editMinStock').value) || 10;

            closeModal();
            updateAllTables();
            showAlert('Produto atualizado com sucesso!', 'success');
        }

        function deleteProduct(id) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                products = products.filter(p => p.id !== id);
                updateAllTables();
                showAlert('Produto exclu√≠do com sucesso!', 'success');
            }
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditingId = null;
        }

        // Busca
        function searchProducts() {
            const search = document.getElementById('searchProduct').value.toLowerCase();
            const rows = document.querySelectorAll('#productsTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // Filtros de movimenta√ß√£o
        function filterMovements() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showAlert('Selecione as datas de in√≠cio e fim', 'warning');
                return;
            }

            const filteredMovements = movements.filter(mov => {
                const movDate = mov.date.toISOString().split('T')[0];
                return movDate >= startDate && movDate <= endDate;
            });

            updateMovementsTableWithData(filteredMovements);
        }

        function clearFilter() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            updateMovementsTable();
        }

        function updateMovementsTableWithData(data) {
            const tbody = document.querySelector('#movementsTable tbody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #9ca3af;">Nenhuma movimenta√ß√£o encontrada</td></tr>';
                return;
            }

            data.slice().reverse().forEach(mov => {
                const product = products.find(p => p.id === mov.productId);
                const typeClass = mov.type === 'IN' ? 'success' : 'danger';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${mov.id}</td>
                        <td>${formatDateTime(mov.date)}</td>
                        <td>${product ? product.name : 'Produto removido'}</td>
                        <td><span class="badge badge-${typeClass}">${mov.type === 'IN' ? 'Entrada' : 'Sa√≠da'}</span></td>
                        <td>${mov.quantity}</td>
                        <td>${mov.user}</td>
                        <td>-</td>
                        <td>${mov.notes || '-'}</td>
                    </tr>
                `;
            });
        }

        // Excel Functions
        function handleExcelImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) {
                        showAlert('Arquivo vazio ou formato inv√°lido', 'danger');
                        return;
                    }

                    importData = jsonData;
                    showImportPreview(jsonData);
                } catch (error) {
                    showAlert('Erro ao ler arquivo: ' + error.message, 'danger');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function showImportPreview(data) {
            const preview = document.getElementById('importPreview');
            const table = document.getElementById('previewTable');
            
            if (data.length === 0) return;

            const headers = Object.keys(data[0]);
            let html = '<table style="width: 100%; margin-top: 10px;"><thead><tr>';
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';

            data.slice(0, 5).forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td>${row[header] || ''}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            if (data.length > 5) {
                html += `<p style="text-align: center; margin-top: 10px; color: #6b7280;">Mostrando 5 de ${data.length} registros</p>`;
            }

            table.innerHTML = html;
            preview.style.display = 'block';
        }

        function confirmImport() {
            const type = document.getElementById('importType').value;
            
            try {
                if (type === 'products') {
                    importProducts();
                } else {
                    importMovements();
                }
                
                document.getElementById('importPreview').style.display = 'none';
                document.getElementById('excelFile').value = '';
                showAlert('Dados importados com sucesso!', 'success');
            } catch (error) {
                showAlert('Erro na importa√ß√£o: ' + error.message, 'danger');
            }
        }

        function importProducts() {
            let imported = 0;
            let skipped = 0;
            const maxId = products.length > 0 ? Math.max(...products.map(p => p.id)) : 0;

            importData.forEach((row, index) => {
                if (row.sku && row.name) {
                    // Verificar se SKU j√° existe
                    if (!products.some(p => p.sku === row.sku)) {
                        const product = {
                            id: maxId + imported + 1,
                            sku: row.sku,
                            name: row.name || row.nome,
                            quantity: parseInt(row.quantity || row.quantidade) || 0,
                            price: parseFloat(row.price || row.preco || row.pre√ßo) || 0,
                            supplier: row.supplier || row.fornecedor || '',
                            minStock: parseInt(row.minStock || row.estoque_minimo) || 10
                        };
                        products.push(product);
                        imported++;
                    } else {
                        skipped++;
                        console.log(`SKU ${row.sku} j√° existe - item ignorado`);
                    }
                }
            });

            updateAllTables();
            
            let message = `${imported} produtos importados`;
            if (skipped > 0) {
                message += `, ${skipped} itens ignorados (SKU duplicado)`;
            }
            showAlert(message, 'success');
        }

        function importMovements() {
            let imported = 0;
            let skipped = 0;
            const maxId = movements.length > 0 ? Math.max(...movements.map(m => m.id)) : 0;

            importData.forEach(row => {
                const product = products.find(p => p.sku === row.sku || p.name === row.produto);
                
                if (product && row.type && row.quantity) {
                    // Verificar se n√£o √© uma movimenta√ß√£o duplicada (mesmo produto, tipo, quantidade e data)
                    const existingMovement = movements.find(m => 
                        m.productId === product.id && 
                        m.type === row.type.toUpperCase() && 
                        m.quantity === parseInt(row.quantity || row.quantidade) &&
                        m.date.toDateString() === (row.date ? new Date(row.date).toDateString() : new Date().toDateString())
                    );

                    if (!existingMovement) {
                        const movement = {
                            id: maxId + imported + 1,
                            productId: product.id,
                            type: row.type.toUpperCase(),
                            quantity: parseInt(row.quantity || row.quantidade) || 0,
                            user: row.user || row.usuario || row.responsavel || 'Sistema',
                            date: row.date ? new Date(row.date) : new Date(),
                            notes: row.notes || row.observacoes || ''
                        };

                        // Atualizar estoque
                        if (movement.type === 'IN') {
                            product.quantity += movement.quantity;
                        } else if (movement.type === 'OUT' && product.quantity >= movement.quantity) {
                            product.quantity -= movement.quantity;
                        } else if (movement.type === 'OUT') {
                            // Se n√£o h√° estoque suficiente, pular esta movimenta√ß√£o
                            skipped++;
                            return;
                        }

                        movements.push(movement);
                        imported++;
                    } else {
                        skipped++;
                        console.log(`Movimenta√ß√£o duplicada encontrada - item ignorado`);
                    }
                } else {
                    skipped++;
                }
            });

            updateAllTables();
            
            let message = `${imported} movimenta√ß√µes importadas`;
            if (skipped > 0) {
                message += `, ${skipped} itens ignorados (duplicados ou produto n√£o encontrado)`;
            }
            showAlert(message, 'success');
        }

        function exportProducts() {
            const data = products.map(p => ({
                ID: p.id,
                SKU: p.sku,
                Nome: p.name,
                Quantidade: p.quantity,
                Pre√ßo: p.price,
                'Valor Total': p.quantity * p.price,
                Fornecedor: p.supplier || '',
                'Estoque M√≠nimo': p.minStock || 10
            }));

            exportToExcel(data, 'produtos');
        }

        function exportMovements() {
            const data = movements.map(m => {
                const product = products.find(p => p.id === m.productId);
                return {
                    ID: m.id,
                    'Data/Hora': formatDateTime(m.date),
                    Produto: product ? product.name : 'Produto removido',
                    SKU: product ? product.sku : '',
                    Tipo: m.type === 'IN' ? 'Entrada' : 'Sa√≠da',
                    Quantidade: m.quantity,
                    Respons√°vel: m.user,
                    Observa√ß√µes: m.notes || ''
                };
            });

            exportToExcel(data, 'movimentacoes');
        }

        function exportInventoryReport() {
            const data = products.map(p => ({
                SKU: p.sku,
                Produto: p.name,
                'Quantidade Atual': p.quantity,
                'Pre√ßo Unit√°rio': p.price,
                'Valor Total': p.quantity * p.price,
                'Estoque M√≠nimo': p.minStock || 10,
                Status: p.quantity <= (p.minStock || 10) ? 'Estoque Baixo' : 'OK',
                Fornecedor: p.supplier || ''
            }));

            exportToExcel(data, 'inventario');
        }

        function exportDashboardData() {
            const totalValue = products.reduce((sum, p) => sum + (p.quantity * p.price), 0);
            const totalStock = products.reduce((sum, p) => sum + p.quantity, 0);
            
            const data = [{
                'Total de Produtos': products.length,
                'Itens em Estoque': totalStock,
                'Valor Total': totalValue,
                'Movimenta√ß√µes Hoje': movements.filter(m => 
                    m.date.toDateString() === new Date().toDateString()
                ).length
            }];

            exportToExcel(data, 'dashboard');
        }

        function exportToExcel(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Dados');
            
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `${filename}_${date}.xlsx`);
        }

        function downloadTemplate(type) {
            let data = [];
            
            if (type === 'products') {
                data = [
                    {
                        sku: 'FOGO001',
                        name: 'Roj√£o Colorido',
                        quantity: 50,
                        price: 15.90,
                        supplier: 'Fogos S√£o Jo√£o',
                        minStock: 10
                    },
                    {
                        sku: 'FOGO002',
                        name: 'Morteiro 4 Polegadas',
                        quantity: 25,
                        price: 95.00,
                        supplier: 'Pirotecnia Brasil',
                        minStock: 5
                    },
                    {
                        sku: 'FOGO003',
                        name: 'Chuva de Ouro',
                        quantity: 30,
                        price: 45.50,
                        supplier: 'Fogos Minas',
                        minStock: 8
                    }
                ];
            } else if (type === 'movements') {
                data = [
                    {
                        sku: 'FOGO001',
                        type: 'IN',
                        quantity: 20,
                        user: 'Jo√£o Silva',
                        date: '2023-01-01',
                        notes: 'Reposi√ß√£o estoque'
                    },
                    {
                        sku: 'FOGO002',
                        type: 'OUT',
                        quantity: 5,
                        user: 'Maria Santos',
                        date: '2023-01-02',
                        notes: 'Venda evento'
                    }
                ];
            }

            exportToExcel(data, `template_${type}`);
        }

        // Relat√≥rios
        function updateReports() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            // Movimenta√ß√µes do m√™s
            const monthlyMovements = movements.filter(m => 
                m.date.getMonth() === currentMonth && m.date.getFullYear() === currentYear
            );

            const monthlyIn = monthlyMovements.filter(m => m.type === 'IN')
                .reduce((sum, m) => sum + m.quantity, 0);
            const monthlyOut = monthlyMovements.filter(m => m.type === 'OUT')
                .reduce((sum, m) => sum + m.quantity, 0);

            document.getElementById('monthlyIn').textContent = monthlyIn;
            document.getElementById('monthlyOut').textContent = monthlyOut;

            // Taxa de giro (simplificada)
            const totalStock = products.reduce((sum, p) => sum + p.quantity, 0);
            const turnover = totalStock > 0 ? ((monthlyOut / totalStock) * 100).toFixed(1) : 0;
            document.getElementById('turnoverRate').textContent = turnover + '%';

            // Valor m√©dio do estoque
            const avgValue = products.length > 0 ? 
                products.reduce((sum, p) => sum + (p.quantity * p.price), 0) / products.length : 0;
            document.getElementById('avgStockValue').textContent = formatCurrency(avgValue);

            // An√°lise ABC
            updateABCAnalysis();
        }

        function updateABCAnalysis() {
            const productsWithValue = products.map(p => ({
                ...p,
                totalValue: p.quantity * p.price
            })).sort((a, b) => b.totalValue - a.totalValue);

            const totalValue = productsWithValue.reduce((sum, p) => sum + p.totalValue, 0);
            let cumulativeValue = 0;

            const abcData = productsWithValue.map(p => {
                cumulativeValue += p.totalValue;
                const percentage = (cumulativeValue / totalValue * 100);
                
                let classification = 'C';
                if (percentage <= 80) classification = 'A';
                else if (percentage <= 95) classification = 'B';

                return {
                    ...p,
                    classification,
                    percentage: (p.totalValue / totalValue * 100).toFixed(2)
                };
            });

            const tbody = document.querySelector('#abcTable tbody');
            tbody.innerHTML = '';

            abcData.slice(0, 10).forEach(item => {
                const badgeClass = item.classification === 'A' ? 'success' : 
                                 item.classification === 'B' ? 'warning' : 'danger';
                
                tbody.innerHTML += `
                    <tr>
                        <td><span class="badge badge-${badgeClass}">${item.classification}</span></td>
                        <td>${item.name}</td>
                        <td>${formatCurrency(item.totalValue)}</td>
                        <td>${item.percentage}%</td>
                    </tr>
                `;
            });
        }

        // Utilit√°rios
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatDateTime(date) {
            return new Intl.DateTimeFormat('pt-BR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }

        function getStatusLabel(quantity) {
            if (quantity === 0) return 'Sem Estoque';
            if (quantity < 5) return 'Estoque Cr√≠tico';
            if (quantity < 10) return 'Estoque Baixo';
            return 'OK';
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <span>${type === 'success' ? '‚úì' : type === 'warning' ? '‚ö†Ô∏è' : '‚ùå'}</span>
                ${message}
            `;
            
            document.querySelector('.content').insertBefore(alertDiv, document.querySelector('.content').firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
        }

        // Event listeners para fechar modal clicando fora
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeModal();
            }
        });

        // Atalhos de teclado
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>