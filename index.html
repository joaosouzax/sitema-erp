import React, { useState, useEffect, useRef } from 'react';
import { QrCode, Barcode, Package, TrendingUp, TrendingDown, History, Camera, Plus, Edit2, Trash2, Save, X, Search, LogOut, Users } from 'lucide-react';

const ERPSystem = () => {
  const [currentUser, setCurrentUser] = useState(null);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [lastUpdate, setLastUpdate] = useState(Date.now());

  const [users, setUsers] = useState([
    { id: Date.now(), nome: 'Admin', email: 'admin@erp.com', senha: '123456', role: 'admin', ativo: true }
  ]);

  const [products, setProducts] = useState([
    { id: Date.now() + 1, codigo: 'PRD001', nome: 'Produto Exemplo', categoria: 'Eletr√¥nicos', estoque: 100, estoqueMin: 10, preco: 150.00, barcode: 'PRD001-BAR', qrcode: 'PRD001-QR' }
  ]);

  const [movements, setMovements] = useState([]);
  const [userForm, setUserForm] = useState({ nome: '', email: '', senha: '', role: 'usuario' });
  const [productForm, setProductForm] = useState({ codigo: '', nome: '', categoria: '', estoque: 0, estoqueMin: 0, preco: 0 });
  const [movementForm, setMovementForm] = useState({ produtoId: '', tipo: 'entrada', quantidade: 0, observacao: '' });
  const [searchTerm, setSearchTerm] = useState('');
  const [editingId, setEditingId] = useState(null);
  const [showScanner, setShowScanner] = useState(false);
  const [scannerType, setScannerType] = useState('manual');
  const videoRef = useRef(null);

  useEffect(() => {
    const interval = setInterval(() => setLastUpdate(Date.now()), 3000);
    return () => clearInterval(interval);
  }, []);

  // üîê Login
  const handleLogin = (email: string, senha: string) => {
    const user = users.find(u => u.email === email && u.senha === senha && u.ativo);
    if (user) {
      setCurrentUser(user);
      setActiveTab('dashboard');
      return true;
    }
    return false;
  };

  const handleLogout = () => {
    setCurrentUser(null);
    setActiveTab('dashboard');
  };

  // Login UI
  const LoginScreen = () => {
    const [loginEmail, setLoginEmail] = useState('');
    const [loginSenha, setLoginSenha] = useState('');
    const [loginError, setLoginError] = useState('');

    const handleSubmit = (e: React.FormEvent) => {
      e.preventDefault();
      if (handleLogin(loginEmail, loginSenha)) setLoginError('');
      else setLoginError('Credenciais inv√°lidas!');
    };

    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-600 to-purple-600 p-6">
        <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
          <div className="flex flex-col items-center mb-8">
            <div className="bg-indigo-500 w-16 h-16 rounded-xl flex items-center justify-center mb-4">
              <Package className="text-white" size={32} />
            </div>
            <h1 className="text-3xl font-bold text-gray-800">ERP Moderno</h1>
            <p className="text-gray-500 mt-1">Gest√£o Inteligente de Estoque</p>
          </div>
          <form onSubmit={handleSubmit} className="space-y-4">
            <input
              type="email"
              placeholder="Email"
              value={loginEmail}
              onChange={(e) => setLoginEmail(e.target.value)}
              className="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-indigo-500"
              required
            />
            <input
              type="password"
              placeholder="Senha"
              value={loginSenha}
              onChange={(e) => setLoginSenha(e.target.value)}
              className="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-indigo-500"
              required
            />
            {loginError && <div className="bg-red-50 text-red-600 px-4 py-2 rounded-lg">{loginError}</div>}
            <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 transition">Entrar</button>
          </form>
          <p className="text-center text-sm text-gray-500 mt-6">Padr√£o: admin@erp.com / 123456</p>
        </div>
      </div>
    );
  };

  // Dashboard simplificado
  const Dashboard = () => {
    const totalProducts = products.length;
    const totalStock = products.reduce((sum, p) => sum + p.estoque, 0);
    const lowStock = products.filter(p => p.estoque <= p.estoqueMin).length;
    const todayMovements = movements.filter(m => new Date(m.data).toDateString() === new Date().toDateString()).length;

    return (
      <div className="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div className="bg-gradient-to-r from-indigo-500 to-blue-500 text-white rounded-2xl p-6 shadow-lg">
          <p>Total de Produtos</p>
          <h2 className="text-3xl font-bold">{totalProducts}</h2>
        </div>
        <div className="bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl p-6 shadow-lg">
          <p>Estoque Total</p>
          <h2 className="text-3xl font-bold">{totalStock}</h2>
        </div>
        <div className="bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-2xl p-6 shadow-lg">
          <p>Estoque Baixo</p>
          <h2 className="text-3xl font-bold">{lowStock}</h2>
        </div>
        <div className="bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-2xl p-6 shadow-lg">
          <p>Movimenta√ß√µes Hoje</p>
          <h2 className="text-3xl font-bold">{todayMovements}</h2>
        </div>
      </div>
    );
  };

  // Layout principal
  if (!currentUser) return <LoginScreen />;

  return (
    <div className="flex h-screen bg-gray-100">
      {/* Sidebar */}
      <aside className="w-64 bg-white shadow-lg flex flex-col">
        <div className="flex items-center space-x-3 p-6 border-b">
          <div className="bg-indigo-500 p-2 rounded-lg">
            <Package className="text-white" size={28} />
          </div>
          <div>
            <h1 className="font-bold text-gray-800">ERP Moderno</h1>
            <p className="text-xs text-gray-500">Gest√£o de Estoque</p>
          </div>
        </div>
        <nav className="flex-1 p-4 space-y-2">
          <button onClick={() => setActiveTab('dashboard')} className={`flex items-center w-full px-4 py-2 rounded-lg ${activeTab === 'dashboard' ? 'bg-indigo-100 text-indigo-700 font-semibold' : 'text-gray-600 hover:bg-gray-100'}`}>
            <History className="mr-3" size={20} /> Dashboard
          </button>
          <button onClick={() => setActiveTab('products')} className={`flex items-center w-full px-4 py-2 rounded-lg ${activeTab === 'products' ? 'bg-indigo-100 text-indigo-700 font-semibold' : 'text-gray-600 hover:bg-gray-100'}`}>
            <Barcode className="mr-3" size={20} /> Produtos
          </button>
          <button onClick={() => setActiveTab('movements')} className={`flex items-center w-full px-4 py-2 rounded-lg ${activeTab === 'movements' ? 'bg-indigo-100 text-indigo-700 font-semibold' : 'text-gray-600 hover:bg-gray-100'}`}>
            <TrendingUp className="mr-3" size={20} /> Movimenta√ß√µes
          </button>
          {currentUser?.role === 'admin' && (
            <button onClick={() => setActiveTab('users')} className={`flex items-center w-full px-4 py-2 rounded-lg ${activeTab === 'users' ? 'bg-indigo-100 text-indigo-700 font-semibold' : 'text-gray-600 hover:bg-gray-100'}`}>
              <Users className="mr-3" size={20} /> Usu√°rios
            </button>
          )}
        </nav>
        <div className="p-4 border-t">
          <button onClick={handleLogout} className="flex items-center w-full px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600">
            <LogOut className="mr-2" size={18} /> Sair
          </button>
        </div>
      </aside>

      {/* Conte√∫do */}
      <main className="flex-1 overflow-y-auto">
        <header className="p-6 bg-white shadow flex justify-between items-center">
          <div>
            <h2 className="text-xl font-bold text-gray-800 capitalize">{activeTab}</h2>
            <p className="text-xs text-gray-500">Atualizado: {new Date(lastUpdate).toLocaleTimeString()}</p>
          </div>
          <div className="text-right">
            <p className="text-sm font-semibold">{currentUser.nome}</p>
            <p className="text-xs text-gray-500">{currentUser.role}</p>
          </div>
        </header>

        <div className="p-6">
          {activeTab === 'dashboard' && <Dashboard />}
          {activeTab === 'products' && <div>üì¶ Gest√£o de Produtos</div>}
          {activeTab === 'movements' && <div>üîÑ Movimenta√ß√µes de Estoque</div>}
          {activeTab === 'users' && currentUser.role === 'admin' && <div>üë• Gest√£o de Usu√°rios</div>}
        </div>
      </main>
    </div>
  );
};

export default ERPSystem;
