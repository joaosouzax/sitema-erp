import tkinter as tk
from tkinter import ttk, messagebox
from core.user_management import UserManager
from modules.estoque.controllers import EstoqueController
from modules.vendas.controllers import VendasController
from modules.compras.controllers import ComprasController
from modules.relatorios.controllers import RelatoriosController
from core.excel_integration import ExcelExporter
from core.barcode_integration import BarcodeGenerator

class MainApplication:
    def __init__(self, master):
        self.master = master
        master.title("Sistema ERP - Loja de Fogos de Artifício")

        self.user_manager = UserManager()
        self.estoque_controller = EstoqueController()
        self.vendas_controller = VendasController()
        self.compras_controller = ComprasController()
        self.relatorios_controller = RelatoriosController()
        self.excel_exporter = ExcelExporter()
        self.barcode_generator = BarcodeGenerator()

        self.user = None
        self.create_login_page()

    def create_login_page(self):
        self.login_frame = ttk.Frame(self.master, padding="12")
        self.login_frame.pack(fill=tk.BOTH, expand=True)

        ttk.Label(self.login_frame, text="Usuário:").grid(column=0, row=0, sticky=tk.W)
        self.username_entry = ttk.Entry(self.login_frame, width=20)
        self.username_entry.grid(column=1, row=0, sticky=tk.E)

        ttk.Label(self.login_frame, text="Senha:").grid(column=0, row=1, sticky=tk.W)
        self.password_entry = ttk.Entry(self.login_frame, width=20, show="*")
        self.password_entry.grid(column=1, row=1, sticky=tk.E)

        ttk.Button(self.login_frame, text="Login", command=self.login).grid(column=1, row=2, sticky=tk.E)

    def login(self):
        username = self.username_entry.get()
        password = self.password_entry.get()
        user = self.user_manager.authenticate_user(username, password)
        if user:
            self.user = user
            self.login_frame.destroy()
            self.create_main_page()
        else:
            messagebox.showerror("Erro de Login", "Usuário ou senha incorretos.")

    def create_main_page(self):
        self.main_frame = ttk.Frame(self.master, padding="12")
        self.main_frame.pack(fill=tk.BOTH, expand=True)

        ttk.Label(self.main_frame, text=f"Logado como: {self.user['username']} ({self.user['role']})").pack()

        # Abas
        self.notebook = ttk.Notebook(self.main_frame)
        self.notebook.pack(fill=tk.BOTH, expand=True)

        self.create_estoque_tab()
        self.create_vendas_tab()
        self.create_compras_tab()
        self.create_relatorios_tab()
        self.create_barcode_tab()

    def create_estoque_tab(self):
        self.estoque_tab = ttk.Frame(self.notebook, padding="12")
        self.notebook.add(self.estoque_tab, text="Estoque")

        # Widgets para gerenciar o estoque
        ttk.Label(self.estoque_tab, text="Nome:").grid(column=0, row=0, sticky=tk.W)
        self.estoque_nome_entry = ttk.Entry(self.estoque_tab, width=30)
        self.estoque_nome_entry.grid(column=1, row=0, sticky=tk.E)

        ttk.Label(self.estoque_tab, text="Descrição:").grid(column=0, row=1, sticky=tk.W)
        self.estoque_descricao_entry = ttk.Entry(self.estoque_tab, width=30)
        self.estoque_descricao_entry.grid(column=1, row=1, sticky=tk.E)

        ttk.Label(self.estoque_tab, text="Quantidade:").grid(column=0, row=2, sticky=tk.W)
        self.estoque_quantidade_entry = ttk.Entry(self.estoque_tab, width=10)
        self.estoque_quantidade_entry.grid(column=1, row=2, sticky=tk.E)

        ttk.Label(self.estoque_tab, text="Preço de Compra:").grid(column=0, row=3, sticky=tk.W)
        self.estoque_preco_compra_entry = ttk.Entry(self.estoque_tab, width=10)
        self.estoque_preco_compra_entry.grid(column=1, row=3, sticky=tk.E)

        ttk.Label(self.estoque_tab, text="Preço de Venda:").grid(column=0, row=4, sticky=tk.W)
        self.estoque_preco_venda_entry = ttk.Entry(self.estoque_tab, width=10)
        self.estoque_preco_venda_entry.grid(column=1, row=4, sticky=tk.E)

        ttk.Label(self.estoque_tab, text="Categoria:").grid(column=0, row=5, sticky=tk.W)
        self.estoque_categoria_entry = ttk.Entry(self.estoque_tab, width=20)
        self.estoque_categoria_entry.grid(column=1, row=5, sticky=tk.E)

        ttk.Label(self.estoque_tab, text="Fornecedor:").grid(column=0, row=6, sticky=tk.W)
        self.estoque_fornecedor_entry = ttk.Entry(self.estoque_tab, width=20)
        self.estoque_fornecedor_entry.grid(column=1, row=6, sticky=tk.E)

        ttk.Button(self.estoque_tab, text="Adicionar Item", command=self.adicionar_item_estoque).grid(column=1, row=7, sticky=tk.E)

        # Treeview para listar os itens
        self.estoque_tree = ttk.Treeview(self.estoque_tab, columns=(0, 1, 2, 3, 4, 5, 6), show='headings')
        self.estoque_tree.grid(column=0, row=8, columnspan=2, sticky=tk.W + tk.E)

        self.estoque_tree.heading(0, text='Nome')
        self.estoque_tree.heading(1, text='Descrição')
        self.estoque_tree.heading(2, text='Quantidade')
        self.estoque_tree.heading(3, text='Preço Compra')
        self.estoque_tree.heading(4, text='Preço Venda')
        self.estoque_tree.heading(5, text='Categoria')
        self.estoque_tree.heading(6, text='Fornecedor')

        self.atualizar_lista_estoque()

    def adicionar_item_estoque(self):
        nome = self.estoque_nome_entry.get()
        descricao = self.estoque_descricao_entry.get()
        quantidade = self.estoque_quantidade_entry.get()
        preco_compra = self.estoque_preco_compra_entry.get()
        preco_venda = self.estoque_preco_venda_entry.get()
        categoria = self.estoque_categoria_entry.get()
        fornecedor = self.estoque_fornecedor_entry.get()

        try:
            quantidade = int(quantidade)
            preco_compra = float(preco_compra)
            preco_venda = float(preco_venda)
        except ValueError:
            messagebox.showerror("Erro", "Quantidade e preços devem ser números válidos.")
            return

        self.estoque_controller.adicionar_item(nome, descricao, quantidade, preco_compra, preco_venda, categoria, fornecedor)
        self.atualizar_lista_estoque()
        self.limpar_campos_estoque()

    def atualizar_lista_estoque(self):
        for item in self.estoque_tree.get_children():
            self.estoque_tree.delete(item)

        itens = self.estoque_controller.listar_itens()
        for item in itens:
            self.estoque_tree.insert('', tk.END, values=(item.nome, item.descricao, item.quantidade, item.preco_compra, item.preco_venda, item.categoria, item.fornecedor))

    def limpar_campos_estoque(self):
        self.estoque_nome_entry.delete(0, tk.END)
        self.estoque_descricao_entry.delete(0, tk.END)
        self.estoque_quantidade_entry.delete(0, tk.END)
        self.estoque_preco_compra_entry.delete(0, tk.END)
        self.estoque_preco_venda_entry.delete(0, tk.END)
        self.estoque_categoria_entry.delete(0, tk.END)
        self.estoque_fornecedor_entry.delete(0, tk.END)

    def create_vendas_tab(self):
        self.vendas_tab = ttk.Frame(self.notebook, padding="12")
        self.notebook.add(self.vendas_tab, text="Vendas")

        # Widgets para registrar vendas
        ttk.Label(self.vendas_tab, text="Item ID:").grid(column=0, row=0, sticky=tk.W)
        self.vendas_item_id_entry = ttk.Entry(self.vendas_tab, width=10)
        self.vendas_item_id_entry.grid(column=1, row=0, sticky=tk.E)

        ttk.Label(self.vendas_tab, text="Quantidade:").grid(column=0, row=1, sticky=tk.W)
        self.vendas_quantidade_entry = ttk.Entry(self.vendas_tab, width=10)
        self.vendas_quantidade_entry.grid(column=1, row=1, sticky=tk.E)

        ttk.Label(self.vendas_tab, text="Preço Unitário:").grid(column=0, row=2, sticky=tk.W)
        self.vendas_preco_unitario_entry = ttk.Entry(self.vendas_tab, width=10)
        self.vendas_preco_unitario_entry.grid(column=1, row=2, sticky=tk.E)

        ttk.Button(self.vendas_tab, text="Registrar Venda", command=self.registrar_venda).grid(column=1, row=3, sticky=tk.E)

        # Treeview para listar as vendas
        self.vendas_tree = ttk.Treeview(self.vendas_tab, columns=(0, 1, 2, 3), show='headings')
        self.vendas_tree.grid(column=0, row=4, columnspan=2, sticky=tk.W + tk.E)

        self.vendas_tree.heading(0, text='Data')
        self.vendas_tree.heading(1, text='Item ID')
        self.vendas_tree.heading(2, text='Quantidade')
        self.vendas_tree.heading(3, text='Preço Unitário')

        self.atualizar_lista_vendas()

    def registrar_venda(self):
        item_id = self.vendas_item_id_entry.get()
        quantidade = self.vendas_quantidade_entry.get()
        preco_unitario = self.vendas_preco_unitario_entry.get()

        try:
            item_id = int(item_id)
            quantidade = int(quantidade)
            preco_unitario = float(preco_unitario)
        except ValueError:
            messagebox.showerror("Erro", "Item ID, quantidade e preço devem ser números válidos.")
            return

        self.vendas_controller.registrar_venda(item_id, quantidade, preco_unitario)
        self.atualizar_lista_vendas()
        self.limpar_campos_vendas()

    def atualizar_lista_vendas(self):
        for item in self.vendas_tree.get_children():
            self.vendas_tree.delete(item)

        vendas = self.vendas_controller.listar_vendas()
        for venda in vendas:
            self.vendas_tree.insert('', tk.END, values=(venda.data, venda.item_id, venda.quantidade, venda.preco_unitario))

    def limpar_campos_vendas(self):
        self.vendas_item_id_entry.delete(0, tk.END)
        self.vendas_quantidade_entry.delete(0, tk.END)
        self.vendas_preco_unitario_entry.delete(0, tk.END)

    def create_compras_tab(self):
        self.compras_tab = ttk.Frame(self.notebook, padding="12")
        self.notebook.add(self.compras_tab, text="Compras")

        # Widgets para gerenciar compras
        ttk.Label(self.compras_tab, text="Item ID:").grid(column=0, row=0, sticky=tk.W)
        self.compras_item_id_entry = ttk.Entry(self.compras_tab, width=10)
        self.compras_item_id_entry.grid(column=1, row=0, sticky=tk.E)

        ttk.Label(self.compras_tab, text="Quantidade:").grid(column=0, row=1, sticky=tk.W)
        self.compras_quantidade_entry = ttk.Entry(self.compras_tab, width=10)
        self.compras_quantidade_entry.grid(column=1, row=1, sticky=tk.E)

        ttk.Label(self.compras_tab, text="Preço Unitário:").grid(column=0, row=2, sticky=tk.W)
        self.compras_preco_unitario_entry = ttk.Entry(self.compras_tab, width=10)
        self.compras_preco_unitario_entry.grid(column=1, row=2, sticky=tk.E)

        ttk.Button(self.compras_tab, text="Registrar Compra", command=self.registrar_compra).grid(column=1, row=3, sticky=tk.E)

        # Treeview para listar as compras
        self.compras_tree = ttk.Treeview(self.compras_tab, columns=(0, 1, 2, 3), show='headings')
        self.compras_tree.grid(column=0, row=4, columnspan=2, sticky=tk.W + tk.E)

        self.compras_tree.heading(0, text='Data')
        self.compras_tree.heading(1, text='Item ID')
        self.compras_tree.heading(2, text='Quantidade')
        self.compras_tree.heading(3, text='Preço Unitário')

        self.atualizar_lista_compras()

    def registrar_compra(self):
        item_id = self.compras_item_id_entry.get()
        quantidade = self.compras_quantidade_entry.get()
        preco_unitario = self.compras_preco_unitario_entry.get()

        try:
            item_id = int(item_id)
            quantidade = int(quantidade)
            preco_unitario = float(preco_unitario)
        except ValueError:
            messagebox.showerror("Erro", "Item ID, quantidade e preço devem ser números válidos.")
            return

        self.compras_controller.registrar_compra(item_id, quantidade, preco_unitario)
        self.atualizar_lista_compras()
        self.limpar_campos_compras()

    def atualizar_lista_compras(self):
        for item in self.compras_tree.get_children():
            self.compras_tree.delete(item)

        compras = self.compras_controller.listar_compras()
        for compra in compras:
            self.compras_tree.insert('', tk.END, values=(compra.data, compra.item
